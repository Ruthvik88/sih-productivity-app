{% extends "base.html" %}

{% block head_content %}
    {% if user.role == 'Manager' and chart_labels %}
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {% endif %}
{% endblock %}


{% block body_content %}
<div class="layout-grid">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>GovFlow</h3>
            <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Close sidebar">&times;</button>
        </div>
        <ul>
            <li><a href="{{ url_for('dashboard') }}" class="active">My Dashboard</a></li>
            <li><a href="{{ url_for('profile') }}">Profile</a></li>
            {% if user.role == 'Manager' %}
            <li><a href="{{ url_for('create_goal') }}">Assign Goal</a></li>
            {% endif %}
        </ul>
        <footer>
            <small>Logged in as: {{ user.full_name }}</small><br>
            <small><strong>Score: {{ score }}/100</strong></small><br>
            <small><strong>League: {{ user.league }}</strong></small>
        </footer>
    </aside>

    <main class="main-content">
        <header class="main-header">
            <h1>Dashboard</h1>
            <a href="{{ url_for('logout') }}" role="button" class="secondary outline">Log Out</a>
        </header>
        
        {% if user.role != 'Administrator' %}
            <h2>Your Assigned Goals</h2>
            {% if goals %}
                {% for goal in goals %}
                    <article>
                        <header><strong>{{ goal.title }}</strong> ({{goal.current_value}} / {{goal.target_value}} {{ goal.kpi_name }})</header>
                        <div class="grid">
                            <div>
                                Status: <strong>{{ goal.status }}</strong>
                            </div>
                            <div style="text-align: right;">
                                <!-- --- UI CHANGE: BUTTONS FOR MODALS --- -->
                                <button class="secondary outline" onclick="showHistoryModal({{ goal.id }})">View History</button>
                                <button onclick="showUpdateModal({{ goal.id }}, {{ goal.current_value }}, '{{ goal.status }}', {{ goal.target_value }})">Update Progress</button>
                            </div>
                        </div>
                        <progress value="{{ goal.current_value }}" max="{{ goal.target_value }}"></progress>
                        
                        {% if goal.manager_feedback %}
                            <div style="margin-top: 15px; padding: 10px; border-left: 3px solid var(--pico-primary);">
                                <strong>Manager's Feedback:</strong>
                                <p style="margin: 5px 0 0 0;"><em>"{{ goal.manager_feedback }}"</em></p>
                            </div>
                        {% endif %}
                    </article>
                {% else %}
                    <p>You have no goals assigned yet.</p>
                {% endfor %}
            {% endif %}
        {% endif %}

        {% if user.role == 'Manager' and reports_data %}
            <hr>
            <h2>Your Team's Progress</h2>
            <article>
                <header>Team Performance Chart</header>
                <canvas id="teamPerformanceChart"></canvas>
            </article>
            {% for data in reports_data %}
                <details>
                    <summary>
                        <strong>{{ data.employee.full_name }}</strong> (Score: {{ data.score }}/100)
                        <small style="float: right; margin-left: 1rem;">League: {{ data.employee.league }}</small>
                    </summary>
                    <!-- --- THIS IS THE FIX --- -->
                    <!-- The list of goals is now pre-sorted in routes.py -->
                    {% if data.sorted_goals %}
                        <ul>
                        {% for goal in data.sorted_goals %}
                            <li>
                                {{ goal.title }} - Progress: {{ goal.current_value }} / {{ goal.target_value }}
                                <button class="secondary outline" style="margin-left: 1rem; padding: 2px 8px;" onclick="showHistoryModal({{ goal.id }})">History</button>
                                <form class="feedback-form" data-goal-id="{{ goal.id }}" style="margin-top: 10px;">
                                    <textarea name="feedback" placeholder="Add feedback for this goal...">{{ goal.manager_feedback or '' }}</textarea>
                                    <button type="submit" class="secondary" style="width: auto;">Submit Feedback</button>
                                    <small class="feedback-status" id="feedback-status-{{ goal.id }}" style="display:none; color: var(--pico-color-green-500);"></small>
                                </form>
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <p>No goals assigned yet.</p>
                    {% endif %}
                </details>
            {% endfor %}
        {% endif %}
    </main>
</div>

<!-- --- NEW: MODAL FOR UPDATING PROGRESS --- -->
<dialog id="update-modal">
    <article>
        <header>
            <a href="#close" aria-label="Close" class="close" onclick="closeModal('update-modal')"></a>
            <strong>Update Progress</strong>
        </header>
        <form id="update-form" onsubmit="handleUpdateSubmit(event)">
            <input type="hidden" id="update-goal-id" name="goal_id">
            
            <label for="progress-slider">
                Progress: <span id="progress-value-display">0</span> / <span id="target-value-display">100</span>
            </label>
            <input type="range" id="progress-slider" name="progress" min="0" value="0">
            
            <label for="status-select">Status</label>
            <select id="status-select" name="status">
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
            </select>
            
            <label for="comment-textarea">Update Comment (Required)</label>
            <textarea id="comment-textarea" name="comment" required placeholder="Describe the work you have completed..."></textarea>
            
            <label for="proof-input">Proof Link / Reference (Optional)</label>
            <input type="text" id="proof-input" name="proof_url" placeholder="e.g., e-Office file number, shared document link...">
            
            <footer>
                <button type="button" class="secondary" onclick="closeModal('update-modal')">Cancel</button>
                <button type="submit" id="submit-update-btn">Submit Update</button>
            </footer>
        </form>
    </article>
</dialog>

<!-- --- NEW: MODAL FOR VIEWING HISTORY --- -->
<dialog id="history-modal">
    <article>
        <header>
            <a href="#close" aria-label="Close" class="close" onclick="closeModal('history-modal')"></a>
            <strong id="history-goal-title">Progress History</strong>
        </header>
        <div id="history-content">
            <!-- History will be loaded here by JavaScript -->
            <p>Loading history...</p>
        </div>
        <footer>
            <button onclick="closeModal('history-modal')">Close</button>
        </footer>
    </article>
</dialog>

{% endblock %}

